const axios = require('axios');
const OPENAI_API_KEY = process.env.OPENAI_API_KEY;

/**
 * Scans files or payloads for signs of malware or malicious code.
 * @param {Object} fileData - { filename, fileContent, fileType }
 * @returns {Promise<{malwareDetected: boolean, malwareType: string, evidence: string, quarantineAction: string}>}
 */
async function aiMalwareMonitor(fileData) {
  const prompt = `
You are an AI MalwareMonitor. Analyze the file or payload for malware, viruses, or malicious code. Clearly state if malware is detected, the type, and recommended quarantine or removal action.

File Data:
${JSON.stringify(fileData, null, 2)}

Return as:
malwareDetected: true/false
malwareType: <string>
evidence: <string>
quarantineAction: <string>
  `;
  const response = await axios.post(
    'https://api.openai.com/v1/chat/completions',
    {
      model: 'gpt-4',
      messages: [{ role: "user", content: prompt }],
      temperature: 0.12,
    },
    { headers: { Authorization: `Bearer ${OPENAI_API_KEY}` } }
  );
  try {
    return JSON.parse(response.data.choices[0].message.content);
  } catch {
    return {
      malwareDetected: true,
      malwareType: "Parsing error",
      evidence: "Parsing error",
      quarantineAction: "Quarantine and report"
    };
  }
}

module.exports = { aiMalwareMonitor };
